<!DOCTYPE html>
    <head>
        <!--jQuery References-->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js" type="text/javascript"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.23/jquery-ui.min.js" type="text/javascript"></script>

        <!--Wijmo Widgets JavaScript-->
        <script src="http://cdn.wijmo.com/jquery.wijmo-open.all.2.2.2.min.js" type="text/javascript"></script>
        <script src="http://cdn.wijmo.com/jquery.wijmo-complete.all.2.2.2.min.js" type="text/javascript"></script>

        <!--Wijmo Widgets CSS-->
        <link href="http://cdn.wijmo.com/jquery.wijmo-complete.all.2.2.2.min.css" rel="stylesheet" type="text/css" />
        <!--Theme-->
        <link href="http://cdn.wijmo.com/themes/metro/jquery-wijmo.css" rel="stylesheet" type="text/css" title="rocket-jqueryui" />

        <!--Knockout JS Library-->
        <script src="http://cdn.wijmo.com/external/knockout-2.0.0.js" type="text/javascript"></script>
        <!--Wijmo Knockout Integration Library-->
        <script src="http://cdn.wijmo.com/external/knockout.wijmo.js" type="text/javascript"></script>
    </head>
    <body>
        <style type="text/css">
            .wijmo-wijgrid
            {
                min-height: 100px;
                width: 1200px;
            }
        </style>

        <script id="scriptInit">
            function readUsersData() {
                var usersData = localStorage['data'];
                if (typeof usersData == 'undefined') {
                    return [{
                        "id": 1,
                        "fullname": "Vladislav Romenko",
                        "shortName": "Vlad",
                        "login": "vladislav",
                        "mobile": "+3725013456",
                        "email": "vladislav@rogakopita.ee",
                        "type": "user",
                        "userDisabled": false
                    },{
                        "id": 3,
                        "fullname": "Denis Mighty",
                        "shortName": "Denis",
                        "login": "denis",
                        "mobile": "+3725123457",
                        "email": "denis@rogakopita.ee",
                        "type": "superuser",
                        "userDisabled": false
                    },{
                        "id": 2,
                        "fullname": "Michael Toomert",
                        "shortName": "Michael",
                        "login": "michael",
                        "mobile": "+3725088620",
                        "email": "michael@rogakopita.ee",
                        "type": "user",
                        "userDisabled": false
                    }];
                }

                return JSON.parse(usersData);
            };

            var userData = function(data) {
                this.id = ko.observable(data.id);
                this.fullname = ko.observable(data.fullname);
                this.shortName = ko.observable(data.shortName);
                this.login = ko.observable(data.login);
                this.mobile = ko.observable(data.mobile);
                this.email = ko.observable(data.email);
                this.type = ko.observable(data.type);
                this.userDisabled = ko.observable(data.userDisabled);
            };

            var usersViewModel = function() {
                var self = this;

                var data = readUsersData();
                var tempList = [];
                self.maxUserId = 0;

                $.each(data, function(i) {
                    tempList.push(new userData(data[i]));

                    if (data[i].id > self.maxUserId) {
                        self.maxUserId = data[i].id;
                    }
                })

                self.usersData = ko.observableArray(tempList);
            };

            function addUser() {
                var newUserId = myUsers.maxUserId + 1;
                myUsers.maxUserId = newUserId;

                myUsers.usersData.push(new userData({ id: newUserId, type: "user", userDisabled: true }));
            }

            function deleteUser() {
                var selectedRow = $("#tableUsers").wijgrid("selection").selectedCells();
                var rowId = selectedRow.item(0).value();

                console.log(rowId.toString());

                var userRow;
                for (var i = 0; i < myUsers.usersData().length; i++) {
                    console.log("items: " + JSON.stringify(myUsers.usersData()[i]));
                    if (myUsers.usersData()[i].id() === rowId) {
                        userRow = myUsers.usersData()[i];
                    }
                }

                console.log("deleting item: " + JSON.stringify(userRow));
                // TODO - store it in array for sending to server

                myUsers.usersData.remove(userRow);
            }

            function saveData() {
                console.log(ko.toJSON(myUsers.usersData()));
                localStorage['data'] = ko.toJSON(myUsers.usersData());
            }

            function onSelectionChanged() {
                var selectedRow = $("#tableUsers").wijgrid("selection").selectedCells();
                console.log("onSelectionChanged " + selectedRow.item(0).value().toString());
            };

            var myUsers;

            $(document).ready(function () {
                myUsers = new usersViewModel();
                ko.applyBindings(myUsers);

                $("#buttonAddUser").button();
                $("#buttonSave").button();
                $("#buttonDeleteUser").button();
                $("#buttonNewPassword").button();
                $("#buttonDeactivateUser").button();
            });
        </script>

        <div class="container">
            <div class="header">
                <h2>
                    Users list (double click in cell to edit data, Save works in Chrome only atm)</h2>
            </div>
            <div class="userlist">
                <table id="tableUsers" data-bind="wijgrid: { data: usersData, allowEditing: true,
                    columns: [
                        { headerText: 'ID', width: 50, dataType: 'number', dataFormatString: 'n0', readOnly: true, width: '5%' },
                        { headerText: 'Name', width: 150, width: '20%' },
                        { headerText: 'Nickname', width: 100, width: '10%' },
                        { headerText: 'Login', width: 100, width: '10%' },
                        { headerText: 'Mobile number', width: 100, width: '15%' },
                        { headerText: 'Email', width: 150, width: '20%' },
                        { headerText: 'Type', width: 50, width: '10%' },
                        { headerText: 'Disabled', width: 50, width: '10%', dataType: 'boolean' }
                    ],
                    selectionChanged: onSelectionChanged }">
                </table>
            </div>
            <div class="userdetails">
                <hr>
                <!--<label for="userId">ID: </label><input type="text" id="userId" data-bind="wijinputnumber: { data: id, disabled: true }"/>-->
                <!--<label for="userFullname">Fullname: </label><input type="text" id="userFullname" data-bind="wijtextbox: { data: fullname }" required/>-->
                <!--<label for="userShortname">Short name: </label><input type="text" id="userShortname" data-bind="wijtextbox: { data: shortName }" required/><br>-->
                <!--<label for="userMobile">Mobile number: </label><input type="text" id="userMobile" data-bind="wijtextbox: { data: mobile }"/>-->
                <!--<label for="userEmail">Email: </label><input type="text" id="userEmail" data-bind="wijtextbox: { data: email }"/><br>-->
                <!--<label for="userLogin">Login: </label><input type="text" id="userLogin" data-bind="wijtextbox: { data: login }" required/>-->
                <!--<label for="userPassword">Password: </label><input type="text" id="userPassword" data-bind="wijtextbox: { data: password }" disabled="disabled" required/><br>-->
                <!--<label for="userType">User type: </label><select id="userType" data-bind="wijdropdown: { data: type }">-->
                    <!--<option value="1" selected="selected">user</option>-->
                    <!--<option value="2">superuser</option>-->
                <!--</select>-->
                <!--<label for="userDisabled">Disabled: </label><input type="checkbox" id="userDisabled" data-bind="wijcheckbox: { checked: userDisabled }"/><br>-->
				<br>
                <input type="button" id="buttonAddUser" onclick="addUser()" value="Add new user"/>
                <input type="button" id="buttonSave" onclick="saveData()" value="Save changes"/>
                <input type="button" id="buttonDeleteUser" onclick="deleteUser()" value="Delete user"/>
                <input type="button" id="buttonNewPassword" disabled="disabled" value="Generate new password"/>
                <input type="button" id="buttonDeactivateUser" disabled="disabled" value="Deactive user"/>
            </div>
        </div>
    </body>
</html>
